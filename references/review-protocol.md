# Review 协议（Review Protocol）

目标：把“写得更好”从主观感觉变成可执行的两段式审查，并限制返工轮次，防止无限打磨或反复引入耦合。

灵感来源：/do 的 Phase 6 Review 与 SPARV 的 Review/修复轮次上限（仅借鉴思想）。

补充：如需要把“门禁证据/快照/active_context/输出格式”做一次收尾自检，见 `references/finish-checklist.md`。

---

## 1) 何时必须 Review

开发实施阶段在输出最终总结前，必须进行一次 Review：
- 先确认 **对齐摘要**（目标/成功标准/非目标/约束）没有被实现偏离
- 再检查 **结构质量**（边界、复用、去重、复杂度、可读性）
- 如任务存在长会话/多失败/易中断风险：Review 前必须先更新 `task.md##上下文快照`（见 `references/context-snapshot.md`）
- 如本次变更影响 Public APIs/契约/数据流：Review 前必须校验 `HAGSWorks/active_context.md` 可续作且指针可达（见 `references/active-context.md`）

---

## 2) 两段式 Review（必做）

### 2.1 规格一致性（Spec Conformance）

检查清单：
- 成功标准是否都有对应验证动作/测试证据（引用 `why.md#对齐摘要` 与 `task.md`）
- 非目标是否真的没被“顺手做了”
- 约束条件（不改 DB/不改 API/不引入依赖等）是否被违反
- 风险容忍度（可回滚/不允许停机等）是否被满足
- 版本控制写操作是否按用户授权执行（默认不执行 `git commit/push/merge` 等；见 `references/command-policy.md`）
- `task.md##上下文快照` 是否可续作：关键决策/约束/下一步唯一动作是否完整，且每条结论具备来源标签（见 `references/context-snapshot.md`）
- 快照“事实区”是否只包含可追溯事实（禁止混入推断；推断必须在待确认区）
- `HAGSWorks/active_context.md` 是否可续作：Public APIs 是否齐全且每条具备 `[SRC:CODE] path:line symbol` 指针（禁止无来源事实）

若不一致：
- 先修正对齐摘要/任务清单/实现之一，使三者一致
- 无法一致则触发 `references/failure-protocol.md` 的升级询问

### 2.2 结构与质量（Code Quality）

检查清单（按优先级）：
- **边界与依赖**：是否出现跨层 import、隐藏耦合、循环依赖风险（见 `references/architecture-boundaries.md`）
- **重复与复用**：是否新增重复逻辑、是否把领域逻辑塞进 utils（见 `references/architecture-boundaries.md`、`references/refactoring-anti-coupling.md`）
- **可读性**：命名是否表达领域语义；是否有不必要的抽象/过度泛化
- **可测试性**：关键逻辑是否被拆成可测试单元；测试是否覆盖成功标准
- **性能**：仅当成功标准包含性能指标时才做性能优化（见 `references/quality-gates.md` 的性能门禁）
- **安全**：输入校验、权限边界、敏感信息处理是否到位（见 `references/safety.md`）

#### 2.2.1 止损三问（品味收口，默认推荐）

目的：防止“能做就多做”的范围漂移，把开发从瀑布变成可控的“雕刻”。

- **是否新增了与成功标准无关的抽象/文件？** 若是，优先删减到最小必要改动面  
- **是否触碰了非目标/约束边界？** 若是，优先回滚或升级确认（不要硬做）  
- **是否能用更小 diff 达成同等成功标准？** 若能，收敛改动面并用 `verify_min` 重新验收  

### 2.3 信噪门槛（置信度，默认启用）

目标：减少“挑刺式噪声”，把注意力放在高影响且高确定性的缺陷上，降低返工与争论成本。

规则：
- 对每个问题给出 **置信度 0–100**（仅衡量“问题是否真实存在 + 影响是否成立”，不评判风格偏好）
- 默认只汇报 **≥80** 的问题；<80 的内容不要当作问题提出（除非用户明确要求“更严格/更 nitpick”）

建议刻度：
- 100：确定会出错/违反约束/安全问题（可复现）
- 80–99：高度可能且影响明显（有证据或强模式匹配）
- <80：信息不足或影响不确定（应转为“待确认/假设”，或给验证动作而不是给结论）

产出要求（每条问题必须包含）：
- `[置信度]` + `path:line`（或 `[SRC:CODE]` 指针）
- 为什么重要（影响面/与成功标准或约束的关系）
- 可执行修复建议（尽量最小改动）

---

## 3) 修复轮次上限（默认 3 轮）

为避免无限打磨：
- Review → 修复 → 复测 视为 1 轮
- 最多 3 轮；超过仍不通过 → 停止并向用户汇报问题与选择

触发停止时使用 `⚠️【HelloAGENTS】- 部分失败` 模板（见 `references/failure-protocol.md`）。

---

## 4) Review 的产出要求（写入哪里）

至少写入一处可追溯位置：
- 推荐：在 `task.md` 末尾新增 `## Review 记录`，包含：
  - 发现的问题（≤5条）
  - 采取的修复（≤5条）
  - 复测结果（门禁命令与结果摘要）

原则：Review 记录必须能解释“为什么这次顺手重构不会影响目标”。

推荐追加（可选但高收益）：
- 在 Review 记录中补一行“快照校验结果”（例如：是否需要修正快照、是否存在待确认项影响交付）

