# 断层恢复协议（Resume Protocol）

目标：当会话被压缩/中断、或你无法依赖聊天上下文继续推进时，基于磁盘中的方案包/知识库/代码事实，在 3 分钟内恢复到“可继续执行”的状态。

核心原则：
- 恢复不靠“记忆”，靠**固定读取顺序 + 可验证证据**
- 恢复的产出必须落到**下一步唯一动作**（命令/任务号/文件修改），避免空泛“继续排查”
- 恢复完成前，必须做一次 **5 问 Reboot Check**，强制把“我在哪/要去哪/下一步是什么”说清楚（见第 2 节第 5 步）

---

## 1) 什么时候触发

命中任一即触发恢复流程：
- 用户输入包含“继续/接着/上次/刚才/中断/上下文没了”等续作意图，但当前会话不处于“追问/选择/确认”状态
- 会话明显不连续（例如中断后重进）或你无法解释“当前任务目标/下一步”
- 工具调用密集或失败反复，怀疑上下文即将被压缩（可参考 `references/context-budget.md`）

---

## 2) 固定恢复顺序（只读优先）

按顺序执行，禁止跳步（除非目录不存在）：

0. **确定项目根目录（Repo Root）**
   - 优先使用 `git rev-parse --show-toplevel` 作为 `PROJECT_ROOT`
   - 若失败（非 git 仓库/权限/工具不可用）：以当前工作目录作为 `PROJECT_ROOT`（并在快照“待确认/假设”区标注 `[SRC:INFER][置信度: 中]`）
   - 后续所有 `HAGWroks/...` 路径（plan/wiki/history/active_context/project 等）都必须相对 `PROJECT_ROOT` 定位与读取
   - monorepo/多子项目：若用户明确指定“以某子目录为工作区根目录”，以用户指定为准，并写入 `HAGWroks/project.md#项目能力画像`

1. **定位方案包**
   - 优先使用已知 `CURRENT_PACKAGE/CREATED_PACKAGE`（如会话中可得）
   - 否则扫描 `${PROJECT_ROOT}/HAGWroks/plan/`：
     - 0 个：提示用户先 `~plan` 创建方案
     - 1 个：直接选中
     - 多个：列出清单让用户选（禁止擅自猜）

2. **读取对齐摘要（防跑偏）**
   - 读 `{package}/why.md#对齐摘要`：目标/成功标准/非目标/约束/风险容忍度/偏好

3. **读取任务状态与检查点（找回进度）**
   - 读 `{package}/task.md`：
     - 任务状态分布（[ ]/[√]/[X]/[-]/[?]）
     - `## 上下文快照` 的最新检查点（Workset + 下一步唯一动作）
     - 若存在 `### 待用户输入（Pending）` 且有内容：视为“等待状态”，优先按 Pending 继续（不要凭感觉继续执行）

   > 例外（允许提前结束恢复）：若 `Pending` 已明确“等待用户输入/选择/确认”的下一步唯一动作，可在此停止继续读取 how.md/active_context 等步骤，直接输出交互询问并等待用户回复。

4. **读取执行约束（防重复/防耦合）**
   - 读 `{package}/how.md`：边界与依赖 / 复用与去重策略 / 重构范围与不变量 / 质量门禁

5. **5 问 Reboot Check（强制）**
   - 目的：在压缩/中断后，把任务状态压缩成“可继续执行”的确定性描述，避免凭感觉继续导致跑偏
   - 填写模板（允许写入 `task.md##上下文快照` 的检查点区，便于续作）：

     | 问题 | 回答（必须具体） |
     |---|---|
     | 我在哪？ | 当前阶段（需求/方案/执行/Review）+ 当前方案包（如有） |
     | 我要去哪？ | 下一阶段/剩余里程碑（≤3条） |
     | 目标是什么？ | 1 句话目标（来自 `why.md#对齐摘要`） |
     | 我学到了什么？ | 3–5 条带证据的发现（优先 `[SRC:CODE]`） |
     | 我做了什么？ | 已完成任务号/门禁/改动面（引用 `task.md`/`git diff --stat`） |

6. **读取 Active Context（如涉及公共接口/契约）**
   - 读 `HAGWroks/active_context.md`：
     - 只信带 `[SRC:CODE]` 指针的条目
     - 需要时用 `rg` 反查 symbol，校验指针未漂移（细则见 `references/active-context.md`）

7. **对齐真实代码状态**
   - `git status` / `git diff --stat`：确认实际改动面
   - 若与 `task.md` 状态不一致：在 `task.md##上下文快照` 记录一次“纠偏检查点”（标注来源）

---

## 3) 恢复后的最小产出（必须给出）

恢复完成后必须明确：
- 当前目标（1 句话）
- 当前进度（任务号/状态摘要）
- **下一步唯一动作**（命令/任务号/文件修改，必须可执行）
- 待确认点（≤3，且标注 `[SRC:TODO]` 或 `[SRC:INFER][置信度]`）

并把“下一步唯一动作”写回 `task.md##上下文快照`（作为新的检查点）。

### 3.1 若检测到 Pending（等待用户输入）

当 `{package}/task.md##上下文快照###待用户输入（Pending）` 有内容时：
- 本轮输出必须使用 `templates/output-format.md` 的交互格式（带 `回复契约` + `<helloagents_state status: awaiting_user_input>`）
- 只复述 Pending 中的“问题/选项/影响”，并要求用户按回复契约作答
- 将下一步唯一动作固定为：等待用户回复（避免“继续排查”式空转）

---

## 4) 恢复失败时的处理

- **方案包缺失/不完整**：按 `develop/SKILL.md` 的“方案包不存在/不完整”错误处理；必要时建议重新 `~plan`
- **多个方案包无法判断**：必须询问用户选择（列出清单）
- **对齐摘要缺失或明显过时**：回到需求分析/方案设计补齐（或将相关任务标记为 `[?]` 等待确认）
