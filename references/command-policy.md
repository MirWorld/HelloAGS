# 命令分级口径（只读命令 vs 有副作用命令）

目标：把“能不能跑命令”从感觉变成可执行规则，避免规划阶段误触构建/安装/迁移带来的噪声与状态污染。

适用：所有阶段，尤其是 `~plan`（规划域）与 `~exec`（执行域）的边界。

---

## 1) 定义（无歧义）

### 只读命令（允许）

定义：只读取信息并输出结果，不改变项目状态：
- 不写入工作区文件（含未跟踪文件）
- 不安装/升级依赖
- 不启动服务/不迁移数据/不生成产物

常见示例：
- 搜索/浏览：`rg`、`Get-ChildItem`、`Get-Content`
- Git 只读：`git status`、`git diff --stat`、`git log`
- Git 只读（更多）：`git show`、`git ls-files`
- 环境探测：`<tool> --version`、`<tool> --help`

### 有副作用命令（禁止于规划域）

定义：任何会改变项目状态、依赖、数据或产生/修改产物的命令。

常见示例：
- 依赖/环境：`npm/pnpm/yarn install`、`pip install`、`go get`
- 构建/测试/格式化：`build`、`test`、`fmt`、`lint --fix`（通常会产生缓存/产物/改文件）
- 运行/迁移：启动服务、生成代码、数据库迁移、`docker compose up`
- 版本控制写操作：`git add`、`git commit`、`git push`、`git merge`、`git rebase`、`git reset`、`git tag`

---

## 2) 规则（与路由联动）

- **规划域（~plan / 方案设计阶段）**：只允许只读命令；禁止有副作用命令（需要验证则写入 `task.md##上下文快照` 的“下一步唯一动作”，等切到执行域再跑）
- **执行域（~exec / 开发实施阶段）**：允许执行门禁/验证/构建/测试，但必须遵循 `references/quality-gates.md` 与失败协议
- **版本控制写操作（Git）**：无论是否在执行域，除非用户明确要求，否则不执行 `git add/commit/push/merge/rebase/reset/tag`；若用户要求，先确认目标分支/远端/提交信息规范，并检查是否包含敏感信息

---

## 3) 灰区处理（不确定就按“有副作用”）

当无法确定命令是否会写入文件/产生缓存/改变环境时：
- 默认按“有副作用命令”处理（规划域禁止）
- 先改为只读替代：`--help/--version`、只读列出配置、读锁文件而非安装
- 需要跑命令时：先落盘“为什么要跑/跑什么/预期是什么”，并请求切换到执行域
