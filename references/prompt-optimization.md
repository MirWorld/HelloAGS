# 提示词/规则优化（Trigger-only）

目标：在用户明确提出“优化提示词/系统提示/规则文件/输出格式控制”时，用一套**最小但高确定性**的流程，把需求从“模糊描述”收敛到“可验收、可复测”的提示词交付；默认不影响 HelloAGENTS 的常规开发主线。

---

## 0) 触发条件（未命中则不要读本文件）

命中任一即视为“提示词/规则优化任务”：
- 明确出现：提示词 / prompt / system prompt / 规则文件 / output format / 让模型按格式输出 / 优化我的指令
- 用户提供一段现有提示词并要求：诊断、改写、加约束、加示例、提高稳定性

未命中：按 `references/routing.md` 的正常路由执行；不要把本文件当成通用流程。

---

## 1) 默认路由与写入范围（避免跑偏）

默认路由：**咨询问答（问答型）**。

默认写入范围：`no_write`（仅在对话里给方案/版本对比/测试用例）。

仅当用户明确要求“写入到项目文件/规则文件（例如 .cursorrules、README、项目约束文档）”时才提升写入范围：
- 写到 `HAGWroks/` 工作区（版本留存/续作）→ `helloagents_only`
- 写到业务仓库文件（规则文件/配置/代码）→ `code_write`（仍受执行域护栏/质量门禁约束）

---

## 2) Intake：把问题压到可执行（RTCF × Intent Model）

本类任务优先用 RTCF（Role/Task/Constraints/Format）快速收敛；必要时再补齐 6 槽意图模型（见 `references/cognitive-core.md`）。

### 2.1 RTCF 最小闭包（必须得到）

- **Role（角色）**：模型要扮演什么？（专业背景/口径/风格边界）
- **Task（任务）**：要做什么？（具体行为，避免“优化一下/写好点”）
- **Constraints（约束）**：必须/禁止/边界（含长度、语气、禁区、风险）
- **Format（格式）**：输出结构（JSON/Markdown/固定小节/字段名）

### 2.2 高信息增益追问（最多 1–3 个）

优先问能改变“改写策略”的缺口：
1. 成功标准：输出怎样算“稳定/更好”？（给 1 个验收用例）
2. 失败样例：当前最常见的坏输出是什么？（给 1 个反例）
3. 硬约束：绝对不能做什么？（例如禁止越权/禁止编造/禁止长篇）

---

## 3) 诊断清单（结构 / 语义 / 效果）

### 3.1 结构层面
- 角色是否明确且不自相矛盾？
- 任务是否可执行（可落到动作），是否存在“手段替代目标”？
- 约束是否完整（必须/禁止/边界/长度/风险）？
- 输出格式是否“可机器校验”（字段/顺序/示例）？
- 是否需要 1–2 个 few-shot 示例来稳定格式？

### 3.2 语义层面
- 是否存在歧义词（例如“详细/简洁/尽快/专业/优化”）未定义？
- 指令是否冲突（例如“尽可能详细但保持极简”）？
- 是否有隐含假设没写出（目标读者/上下文/数据来源/权限）？

### 3.3 效果层面（鲁棒性）
- 是否容易被“指令注入/越狱”（用户输入覆盖系统约束）？
- 边缘输入怎么办（空输入/异常字段/超长文本/多语言混杂）？
- 是否过度约束导致输出僵化（每次都重复模板废话）？

---

## 4) 三档交付（只在提示词任务中使用）

> 目的：让用户用最小成本选择“够用 vs 追求极致”，避免一上来就深度重构导致跑偏。

### A) Quick Fix（快速修复）
- 改动：修歧义、补 1–2 条硬约束、补最小输出格式
- 交付：改写后的提示词 + 1 个主用例

### B) Standard（标准优化，推荐）
- 改动：重排结构（Role/Task/Constraints/Format），补 1–2 个 few-shot，补边缘输入处理
- 交付：改写后的提示词 + 2 个测试用例（主用例 + 边缘用例）+ 失败样例如何被约束住

### C) Deep Refactor（深度重构）
- 改动：抽象成“可维护模板”（可复用段落 + 可替换变量），加自检段（自检不暴露推理）
- 交付：模板版提示词 + 用例集 + 演进建议（下一次迭代该补什么）

---

## 5) 测试用例（A/B 证据）

最小要求：至少 2 个用例（主用例 + 边缘用例）。

推荐格式：
- 用例 1（主场景）
  - 输入：…
  - 期望：…
  - 失败判定：…
- 用例 2（边缘/对抗）
  - 输入：…
  - 期望：…
  - 失败判定：…

---

## 6) 安全审计（提示词特有）

当提示词会被用于处理“外部输入/不可信文本”时，必须显式加固：
- **指令注入**：用户文本不得覆盖系统/开发者约束
- **信息泄露**：不得输出密钥/令牌/内部路径/私有数据
- **滥用风险**：对敏感话题给拒绝策略或降级输出

若涉及高风险领域，按 `references/safety.md` 的 EHRB 口径阻断并请求确认。

---

## 7) 冲突约束处理（硬规则）

遇到冲突指令（典型：又要“非常详细”又要“极简”）：
- 必须先改写成可执行约束（二选一或给出优先级）
- 未消除冲突前：不要直接产出“最终提示词”，只能输出澄清问题或给选项让用户选
