# 上下文预算与压缩策略（Context Budget）

目标：在无法获取“剩余 token/上下文百分比”的情况下，仍能可靠推进任务，并避免在会话被压缩/中断时出现信息断层。

核心原则：
- 聊天上下文是**易失缓存**；可恢复进度必须依赖磁盘落盘（方案包/知识库）与代码事实
- 不追求“每步落盘”，只做**触发式检查点（Checkpoint）**
- 落盘必须**事实/推断隔离**（见 `references/context-snapshot.md`），避免把误解固化成事实

---

## 1) 预算状态机（不用 token，也能判断风险）

用可观察信号把当前会话分为 3 档（命中任一条件即可升级档位）：

### Green（正常）
- 工具调用不密集（例如 < 10 次）
- 变更范围可控（≤5 文件）且无跨层契约变化
- 无阻断性失败或已快速定位

动作：
- 按既定流程推进
- 触发条件命中时再写快照（见第 2 节）

### Yellow（开始有断层风险）
任一条件：
- 工具调用开始密集（例如 10–25 次）或读了多个文件片段
- 任务跨度变大：跨模块/跨层（≥3 层）或涉及契约/Schema
- 用户多次调整需求/约束，出现“规格漂移”风险
- 关键规格无法落到可执行验证：成功标准无法映射到验证动作，或无法给出 `verify_min`（最小验证动作）且没有明确的获取路径
- 同一阻断点复现 ≥2 次

动作（必做）：
- 立刻写一次 `task.md##上下文快照` 的**检查点**（Workset + 下一步唯一动作）
- 优先补齐“可验证约束”：把 `verify_min`（最小验证动作）与成功标准映射写清楚；无法确认则进入“待确认/假设”并给出获取方式
- 做一次 **5 问 Reboot Check**，把“我在哪/目标/已做/下一步”说清楚，并写回快照（细则见 `references/resume-protocol.md`）
- 之后每个“关键决策点/阻断失败/最终输出前”都写快照

### Red（高断层风险）
任一条件：
- 连续阻断性失败达到阈值（默认 3，见 `references/failure-protocol.md`）
- 工具调用非常密集（例如 >25 次）或排查路径分叉过多
- 会话可能被打断（长排查/跨时段续作/用户明确可能中止）

动作（必做）：
- 先写检查点快照（必须包含：失败证据 + 下一步唯一动作）
- 做一次 **5 问 Reboot Check**，把当前状态压缩为可续作描述，并写回快照（细则见 `references/resume-protocol.md`）
- 再按 `references/failure-protocol.md` 升级为用户决策（必要时先执行 `references/break-loop-checklist.md`）

---

## 2) 触发式检查点（Checkpoint）怎么写（最小可恢复）

检查点只写“续作必需信息”，建议控制在 6–12 行：

1. **Workset（当前工作集）**：正在改/将改的文件列表（≤7 个）+ 每个 1 句意图
2. **下一步唯一动作**：只允许 1 条（命令/任务号/文件修改）
3. **Constraints（已确认约束）**：只写 `[SRC:USER|CODE]` 可追溯约束
4. **Failure（如有）**：1–3 行错误摘要 + 已尝试 1–2 条（`[SRC:TOOL]`）
5. **Assumptions（如有）**：只能进入“待确认/假设”区（`[SRC:INFER][置信度]`）
6. （推荐）**Repo 状态**：记录 `branch/head/diffstat` 的最小戳（用于识别“包外改动/状态漂移”，避免断层续作误重做）

固定格式与来源标签规则：见 `references/context-snapshot.md`。

---

## 3) “压缩”优先级（不依赖模型自动压缩）

当进入 Yellow/Red，优先做以下动作（按顺序）：
1. **写检查点快照**（先保进度）
2. **改用指针表达**：用 `[SRC:CODE] path symbol`（行号可选）指向事实，避免复制大段代码
3. **收敛信息输入**：只读取与下一步动作相关的最小文件片段（先 `rg` 再局部读取）
4. **把决策写回方案包**：边界/复用/重构预算写 `how.md`；公共接口写 `HAGSWorks/active_context.md`

---

## 4) 与“断层恢复”的关系

- **预算策略**负责：提前预防断层、降低跑偏概率
- **断层恢复协议**负责：断层已发生时，靠磁盘状态重建上下文并继续

断层恢复细则：`references/resume-protocol.md`

