# 子代理调度协议（Subagent Orchestration）

目标：在复杂/不确定任务中，用“可控的多视角并行”提升理解与交付稳定性，同时避免子代理互相干扰、污染主任务方向或扩大改动面。

> 重要：子代理是“只读的侦察/审查器”，不是第二个执行者。主控（Orchestrator）始终是**唯一可写入代码与文档的人**。

---

## 1) 何时启用（触发器）

触发条件与落盘规则：以 `references/checklist-triggers.md` 为准（命中才启用，避免随缘并行）。

---

## 2) 角色划分（最小集合）

- **主控（Orchestrator）**：拆任务、定义边界、创建/更新方案包、最终决策与写入落盘。
- **侦察（Scout）**：只做信息获取（定位文件/调用点/契约/风险点），输出证据指针与缺口清单。
- **独立审查（Reviewer）**：只做一致性/风险/结构质量审查（不写代码），指出问题与建议验证动作。

默认并发上限：**2–3 个**（超过则排队）。

---

## 3) 硬约束（阻断式）

### 3.1 子代理禁止项（命中即停）

子代理必须满足：
- **只读**：禁止写入任何文件（包括方案包、知识库、代码）
- **禁止再分裂**：子代理不得创建/调用其他子代理
- **禁止副作用命令**：不得运行会改变环境/依赖/数据的命令（如 install/build/migrate）
- **禁止扩大范围**：不得提出“重构全局/改架构/大规模迁移”作为默认建议；若确有必要只能写进风险区并要求主控确认

> 若子代理发现“必须改 DB/契约/鉴权”等重大方向变化，只能输出为风险与待确认，不得推动主控直接执行。

### 3.2 子代理允许项（优先）

- 只读文件搜索/定位（例如找入口、调用点、契约载体）
- 只读审查（对齐摘要一致性、潜在耦合、重复、回滚风险）
- 输出验证建议（下一步可执行动作，但由主控决定是否执行）

---

## 4) 输入协议（主控给子代理的最小提示包）

主控给子代理的输入必须包含（缺一则易跑偏）：

1. **目标**：子代理只回答什么（1 句话）
2. **边界**：只看哪些目录/文件（Allow），明确禁止触碰（Deny）
3. **产出格式**：必须按第 5 节输出（结论+证据+风险+下一步）
4. **时间盒**：最多查 10 分钟/最多读 N 个文件片段（防止无限探索）

---

## 5) 输出协议（子代理必须遵守）

子代理输出必须是“可合并的结构化块”，禁止长篇自由发挥：

### 5.1 结论（≤5 条）

- TL;DR: …

### 5.2 证据（必须，可点击可复查）

- [SRC:CODE] path/to/file.ext:123 symbol - 证据说明（1 句）
- [SRC:CODE] path/to/file.ext#L456 symbol - 证据说明（1 句）

> 证据不足的内容不得进入事实区，必须放到“风险/待确认”。

### 5.3 风险 / 不确定点（必须隔离推断）

- [SRC:INFER][置信度: 中] …（给出验证方式）
- [SRC:TODO] 缺失信息: …（影响: …）

### 5.4 主控下一步唯一动作（必须给 1 条）

- 下一步唯一动作: …（命令/文件定位/需要用户确认的问题之一）

---

## 6) 主控合并规则（防污染）

主控在合并子代理输出时必须遵守：
- 只把**带证据**的内容写入 `task.md##上下文快照` 的事实/决策区（来源标签齐全）
- 子代理的推断必须进入快照的“待确认/假设”区（`[SRC:INFER]`）
- 两个子代理结论冲突：按 SSOT 裁决（代码事实 + 可复现验证证据 + 已确认的 `why.md##对齐摘要`）；裁决不了就暂停给用户 2–3 个选项
- 子代理建议不得直接变成改动：先落盘边界/复用/不变量，再进入实现（见 `references/execution-guard.md`）

---

## 7) 无多代理时的替代方案（Multiple Independent Passes）

当环境不支持多代理（或策略/成本原因不启用 spawn）时，主控必须用“多视角独立 Pass”模拟并行侦察/独立审查，以提升结论可靠性并减少单一路径偏差。

### 7.1 适用场景

- 命中 `references/checklist-triggers.md` 的“子代理侦察/独立审查”触发器，但无法/不便使用多代理
- 方案关键路径信息缺口大，且单次探索结果置信度不足
- 连续失败 ≥2，需要快速从另一个角度破局

### 7.2 执行规则（最小可落地）

- **Pass 数量**：默认 2 个；必要时第 3 个（总计不超过 3 个）
- **时间盒**：每个 Pass 10–15 分钟（或最多读取 N 个文件片段），避免无限探索
- **视角隔离**：每个 Pass 先独立产出，再做对照合并；不得“边看边改”，改动只能在合并后进入执行域（见 `references/execution-guard.md`）
- **输出与合并**：每个 Pass 的输出必须满足第 5 节格式，并由主控按第 6 节规则写入 `task.md##上下文快照`

### 7.3 推荐 Pass 模板（按需选 2–3 个）

**Pass A — Scout（只读侦察）**
- 目标：定位入口/调用链/契约载体/副作用点，补齐“可验证事实”
- 输出重点：`[SRC:CODE]` 证据指针 + 缺口清单（缺什么、影响什么、如何验证）

**Pass B — Reviewer（独立审查）**
- 目标：不假设 Pass A 正确，从规格/风险/耦合角度找“最可能出错的点”
- 输出重点：高影响风险（带证据或明确标注为推断）+ 下一步唯一动作（验证或确认）

**Pass C — Cross-layer / Reuse（跨层/复用视角，选做）**
- 目标：当涉及 ≥3 层/改契约/多消费者或准备新增 util 时，从一致性与去重角度补盲点
- 输出重点：受影响层与消费者清单 + 契约变化点 + 复用决策建议（必须带证据指针）
