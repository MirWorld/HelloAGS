# 失败协议（Failure Protocol）

目标：避免在同一个阻塞点上“反复试错空转”；当连续失败达到阈值时，及时停下对齐问题、收敛范围或请求用户决策。

灵感来源：SPARV 的 “3-Failure Protocol”（仅借鉴思想，不依赖任何外部系统）。

---

## 1) 什么算“失败”（只统计阻断性失败）

计入失败计数的典型情况：
- 质量门禁中的**阻断性门禁**失败（构建/类型检查/核心测试/安全红线）
- 明确的环境阻断（依赖无法安装、缺关键环境变量/权限、启动失败且无法定位）
- 方案与现实冲突导致无法继续（例如约束禁止改 DB，但实现必需 DB 变更）
- **会话/工具链异常导致输出不完整**（例如 `response.incomplete`、压缩/续作异常、工具输出被截断），无法确定“已完成了什么/下一步是什么”

不计入失败计数的情况：
- 正常的探索性试错（例如先跑一次命令确认路径）
- 警告性门禁失败（记录即可，不阻断）

阻断/警告分级：以 `references/quality-gates.md` 为准。

---

## 2) 连续失败计数规则（建议阈值：3）

- 维护 `CONSECUTIVE_FAILURES`（连续失败次数）
- 每次阻断性失败：`+1`
- 任一阻断点修复并通过（或明确获得用户决策导致路径改变）：重置为 `0`

达到阈值（默认 3）时：
- **停止继续尝试**
- （推荐）先执行 `references/break-loop-checklist.md` 收敛失败类型/证据/可选路径，再向用户升级决策
- 输出 `⚠️【HelloAGENTS】- 部分失败`（按 `templates/output-format.md` 的异常/交互格式）
- 给出 2–3 个可选决策（收敛范围/补充信息/更换路径/终止）

---

## 3) 失败升级模板（建议使用）

当连续失败达到阈值：

```
⚠️【HelloAGENTS】- 部分失败

连续 3 次阻断性失败，已暂停以避免无效试错。
- 失败点: [构建/类型检查/核心测试/环境阻断/...]
- 最新错误摘要: [1-3行]
- 关键不确定点: [缺少的信息或冲突的约束]

[1] 补充信息 - 提供 [缺失信息清单]
[2] 收敛范围 - 改为 [更小影响面/替代实现]
[3] 终止 - 停止当前执行并保留现状

────
🔄 下一步: 请输入序号选择
回复契约: 只回复 `1` / `2` / `3`

<helloagents_state>
version: 1
mode: exec
phase: develop
status: awaiting_user_input
awaiting_kind: choice
package: HAGSWorks/plan/YYYYMMDDHHMM_<feature>/   # 有方案包则填写
next_unique_action: "等待用户输入序号 1-3"
</helloagents_state>
```

---

## 4) 记录失败（保证可追溯）

每次阻断性失败至少做一件事（择一，优先级从高到低）：
1. **写入上下文快照（推荐）**：在 `task.md##上下文快照` 追加失败条目，包含：
   - 失败点（构建/类型检查/核心测试/环境阻断…）
   - 关键错误摘要（1–3行）
   - 已尝试的修复（1–2条）
   - 下一步唯一动作（可执行命令/需要用户决策）
   - 每条结论标注来源标签（`[SRC:TOOL]`/`[SRC:CODE]`/`[SRC:USER]`；推断只允许出现在待确认区）
   - 细则见：`references/context-snapshot.md`
2. 在 `task.md` 的对应任务下追加 `> 备注: ...`（最低成本）
3. 在 `how.md` 的“假设与不确定性”追加新的阻断因素（适合影响方案选择的阻断）

原则：失败记录必须能让后续接手者复现阻断点（命令/环境/错误摘要）。

补充：若失败属于“输出不完整/压缩或续作异常/模型切换后不确定当前进度”，默认下一步唯一动作应收敛为：
- 写入 `task.md##上下文快照`（记录异常信号 + 已尝试/结论）
- 按 `references/resume-protocol.md` 执行断层恢复（先重建进度/No-Redo 判定，再决定是否继续）

推荐记录格式（结构化，不绑定文案）：
- [SRC:TOOL] model_event: response_incomplete   # 对应 Codex 的 response.incomplete（高风险）
- [SRC:TOOL] model_event: model_rerouted        # 对应 Codex 的 model/rerouted（模型被重定向）

高风险硬规则：若出现 `model_event: response_incomplete`，在进入执行域（改代码/跑门禁）前必须先追加新的恢复检查点（至少包含 `repo_state:` 与 `下一步唯一动作:`），否则视为不确定状态，禁止继续执行（防止断层后重做/二次修改）。

