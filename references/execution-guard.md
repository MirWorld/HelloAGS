# 执行期护栏：执行域声明与 Fail→Narrow（Execution Guard）

目标：在开发实施阶段减少“越界修改/扩大范围自证/反复空转”，让执行过程更可控、更可回滚、更可续作。

本护栏专注两件事：
1) **执行域声明（Domain Declaration）**：在动手前明确 Allow/Deny/新增文件/重构预算  
2) **Fail→Narrow**：失败时先收敛到最小可疑点与最小改动面，禁止直接扩大范围硬修

> 相关概念：Skill 是“外置 Prompt”，用于减少无关干扰、精准约束。执行期护栏是对“执行阶段越界风险”的工程化兜底。

---

## 0) 结构化锚点（提高命中率）

为了让模型更稳定地遵守约束，关键规则使用同一结构（命中即执行）：

### 【关键信号】
- Patch/Update 失败，或修改结果与预期不一致
- 模型开始倾向扩大修改范围（函数 → 文件 → 模块/跨层）
- 读到的代码状态与先前分析依据不一致（状态漂移）
- 多 Agent 并行或多人协作，存在冲突/耦合风险

### 【规则摘要】
- 必须先写/更新**执行域声明**（Allow/Deny/新增文件/重构预算）
- 失败时必须先执行 **Fail→Narrow** 收敛信息与改动面，再决定继续/升级/终止

### 【再次强调】
若在证据不足或边界不清时扩大范围修改，通常会导致：
- 引入重复与耦合回潮
- 破坏非目标/约束
- 断层后无法续作（进度不可恢复）

---

## 1) 执行域声明（必须）

### 1.1 必填字段（最小闭包）

在开始改代码前，必须明确并落盘：

- **Allow（允许修改）**：文件/目录白名单（尽量具体到文件；≤10 个入口）
- **Deny（禁止修改）**：明确不碰的目录/模块/协议层（至少 1 条）
- **New Files（是否允许新增文件）**：默认 `否`；若是，限定允许目录
- **Refactor（是否允许顺手重构）**：默认 `否`；若是，必须绑定预算与不变量（见 `references/refactoring-anti-coupling.md`）

### 1.2 写到哪里（落盘要求）

最小落盘（两处择一，推荐两处都写）：
- `task.md##上下文快照` 的“决策”区（作为可恢复检查点，见 `references/context-snapshot.md`）
- `how.md##重构范围与不变量`（作为结构质量约束，供 Review 裁决）

### 1.3 约束默认值（保守优先）

当用户/方案包未明确授权时，默认：
- `New Files = 否`
- `Refactor = 否`
- `Deny` 至少包含：数据库迁移/协议变更/权限模型重做（除非对齐摘要允许）

---

## 2) Fail→Narrow（失败即收敛）

目的：避免“为了修好而扩大范围”，把失败变成高信息增益的下一步。

### 2.1 何时触发（任一即触发）

- 文件写入/编辑失败，或 Patch 未按预期应用
- 修改后行为与成功标准不一致（或无法验证）
- 需要通过扩大上下文才能“勉强解释合理性”
- 连续两次在同一位置试错仍无确定证据

### 2.2 收敛流程（最多 1 轮）

1. **停止**当前修改尝试（不要继续堆补丁）
2. **回读真实状态**：重新读取目标文件/相关片段，确认代码事实（`[SRC:CODE]`）
3. **最小可疑点**：只保留 1 个最可能的错误点（函数/分支/条件）
4. **最小改动面**：撤销/放弃所有非必要改动（尤其跨模块/新增抽象/重构）
5. **重新评估**：问题是否仍成立？若不成立，回到“缺失信息清单/待确认假设”

收敛后仍失败：
- 进入 `references/failure-protocol.md`（阻断性失败计数/升级用户决策）
- 或按 `references/break-loop-checklist.md` 进一步收敛证据与选项

---

## 3) 越界保护：必须中断并提问

当出现以下任一情况，必须停止执行并切换为提问/确认：
- 无法确认问题是否在当前模块/文件范围内
- 继续修改会触碰 `Deny` 范围
- 需要变更契约/协议/数据库才能实现，但对齐摘要未允许

提问要求（最小信息包）：
- 当前不确定点是什么（1 句话）
- 为什么无法继续（证据不足/约束冲突/环境阻断）
- 需要用户补充什么（≤3 条，高信息增益）
- 给 2–3 个可选决策（收敛范围/更换路径/允许越界/终止）

---

## 4) 与现有机制的关系（不要重复造轮子）

- 触发器矩阵：见 `references/checklist-triggers.md`
- 上下文快照与可恢复检查点：见 `references/context-snapshot.md`、`references/context-budget.md`
- 连续失败升级：见 `references/failure-protocol.md`、`references/break-loop-checklist.md`
- 结构质量与重构预算：见 `references/refactoring-anti-coupling.md`、`references/architecture-boundaries.md`

