# 顺手重构：反重复与反耦合（Refactoring Anti-Coupling）

目标：允许“顺手把结构理顺”，但把重构控制在不影响目标、不过度耦合、不引入重复的安全范围内。

---

## 1) Refactor Budget（重构预算）

默认预算（可按任务调整）：
- 允许：同模块内的命名修正、提取函数、去除重复、简化分支、删除死代码、收敛错误处理
- 谨慎：跨文件移动、抽象公共层、引入新依赖、改变对外 API
- 禁止（除非对齐摘要明确允许）：数据库/协议迁移、权限模型重做、全局架构改造

预算必须写入 `how.md` 的 `## 重构范围与不变量`：
- **允许的重构类型**
- **不变量**（行为/接口/性能/兼容要求）
- **禁止触碰的区域**

---

## 2) 抽象门禁（防止过早抽象）

只有满足以下条件才创建新抽象/公共模块：
- 至少两处重复（或即将出现第三处）
- 抽象不会引入反向依赖/跨层依赖
- 抽象后的命名能表达领域语义（禁止 `utils2`, `common2`）

否则：优先保持局部实现，或做最小提取到当前模块内部（internal/private）。

---

## 3) “utils 膨胀”预防

原则：
- 工具函数应贴近领域（例如 `auth/token.ts` 而不是 `utils/token.ts`）
- 抽象以“名词域”组织，而不是“技术动作”（避免 `helpers/` 变垃圾场）
- 新增公共工具必须说明复用点与边界（写入 `how.md`）

---

## 4) 验证要求（与质量门禁联动）

任何顺手重构完成后：
- 至少跑过覆盖成功标准的测试/验证动作
- 若缺测试：补最小可复现验证步骤（必须可重复）

质量门禁规则：见 `references/quality-gates.md`。

