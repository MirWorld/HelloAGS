# 中期落盘：上下文快照（Context Snapshot）

目标：在对话变长、工具调用增多、失败反复或会话可能被打断时，把“关键决策/约束/下一步唯一动作”以**可验证、可纠错**的方式写回方案包/知识库，降低上下文丢失导致的跑偏与返工。

核心理念：**只固化可追溯的事实；把推断隔离；把不确定性显式化。**

---

## 1) 写到哪里（默认落点）

优先写入当前方案包的 `task.md`，在文末维护一个固定章节：
- `## 上下文快照`

补充写入（按需）：
- 若涉及“团队级偏好/长期约束”变化：同步到 `HAGWroks/project.md` 的“协作与偏好/项目能力画像”
- 若涉及“架构决策”且已稳定：同步到 `how.md` 的 ADR 或知识库 `wiki/arch.md`（按 `kb/SKILL.md`）

**禁止：**把上下文快照当作 SSOT（真值）。SSOT（真值）是：代码事实 + 可复现验证证据（测试/门禁/命令输出）+ 经确认的对齐摘要（`why.md##对齐摘要`）。

---

## 2) 什么时候必须写（触发条件）

任一条件命中即必须写一次快照（可追加一条，不要求重写整段）：

1. **关键决策点**：在多个方案/路径中做出选择（技术路径、模块落点、接口策略、重构范围、降级策略）
2. **约束/验收变化**：用户补充/修改成功标准、非目标、约束、风险容忍度（等价于“需求变更”）
3. **阻断性失败**：构建/类型检查/核心测试/安全红线/环境阻断失败（与 `references/failure-protocol.md` 对齐）
4. **会话抗打断**：预计任务会跨多轮工具调用、跨时段继续、或存在被中断风险（例如：长时间排查、多人协作交接）
5. **最终输出前**：在 `references/review-protocol.md` 的 Review 前，快照必须是最新的（否则 Review 基于过时信息）
6. **交互等待**：本轮输出需要用户输入/选择/确认，且下一轮必须只处理用户回复（建议写入 `### 待用户输入（Pending）` + “下一步唯一动作”）

补充：当出现“上下文预算风险”（工具调用密集/排查分叉/可能中断）时，按 `references/context-budget.md` 进入 Yellow/Red，并优先写一次**检查点（Checkpoint）**，确保可续作。

---

## 3) 来源标签（防止“写错固化”）

### 3.1 标签集合（最小闭包）

对每条快照项必须标注来源标签（其一即可，多来源可并列）：
- `[SRC:USER]`：用户原话（必须引用原句，避免改写引入语义漂移）
- `[SRC:CODE]`：代码事实（给出文件路径 + 关键符号/函数/类；可选给行号）
- `[SRC:TOOL]`：工具输出（给出命令/工具名 + 关键错误摘要）
- `[SRC:INFER]`：推断（必须同时写明 `置信度: 高/中/低`，且只能出现在“待确认/假设”区）
- `[SRC:TODO]`：待确认（必须写明“缺什么信息/谁来确认/确认后影响什么”）

### 3.2 硬规则（必须遵守）

- **事实区不得出现 `[SRC:INFER]`**：推断必须隔离到“待确认/假设”区。
- **无来源结论不得进入事实区**：没有 `[SRC:USER|CODE|TOOL]` 的结论，只能进入“待确认/假设”。
- **优先引用用户原话**：成功标准/禁止项/风险容忍度优先粘贴原句（用引号），减少翻译误差。
- **敏感信息禁止落盘**：密钥/令牌/PII 一律脱敏或省略（遵循 `references/safety.md`）。

### 3.3 外部资料（Web/MCP）记录（推荐）

当快照引用外部资料（联网搜索/MCP/文档）时：
- 使用 `[SRC:TOOL]` 记录来源，并结构化写清：`url/uri + accessed + version + claim + scope + expires + verify`
- 外部资料不得直接进入“事实区”冒充真值；若无法在本地用代码/测试/命令输出锚定，必须进入“待确认/假设”区

细则：`references/external-knowledge.md`

---

## 4) 固定格式（建议原样使用）

在 `task.md` 末尾追加/维护：

```markdown
## 上下文快照

### 已确认事实（可验证）
- [SRC:CODE] ……
- [SRC:TOOL] ……

### 用户原话（验收/约束/偏好）
- [SRC:USER] “……”

### 决策（做了什么选择 + 为什么）
- [SRC:CODE|USER|TOOL] 决策: …
  - 理由: …
  - 影响: …

### 待确认 / 假设（推断必须在此）
- [SRC:INFER][置信度: 中] 假设: …
  - 若成立: …
  - 若不成立: …
  - 需要确认: …
- [SRC:TODO] 缺失信息: …
  - 影响: …

### 待用户输入（Pending）
- [SRC:TODO] 等待用户回答: …（影响: …）
- [SRC:TODO] 等待用户选择: [1] … [2] …（影响: …）

### 错误与尝试（防重复，按需）

| 错误/症状 | 尝试 | 结果/证据 | 结论（避免重复） |
|---|---:|---|---|
| | 1 | | |

### 下一步唯一动作（可执行）
- 下一步唯一动作: `…` 预期: …
```

**写作约束：**
- 每个小节最多 3–5 条；宁可短而精，避免写成冗长复盘
- “下一步唯一动作”必须可执行（命令/文件/任务编号），避免“继续排查”式空话

---

## 4.1) 检查点（Checkpoint）最小写法（推荐）

当会话可能被压缩/中断、或你需要确保“断层也能继续”时，快照至少要包含两件事：

1. **Workset（当前工作集）**：正在改/将改的文件（≤7 个）+ 每个 1 句意图
2. **下一步唯一动作**：只允许 1 条（命令/任务号/文件修改）

推荐放置位置：
- Workset：写在“已确认事实/决策”或单独追加 1 条清单
- 下一步唯一动作：写在“下一步唯一动作（可执行）”第一条

这样即使聊天上下文被裁剪，也能基于磁盘快照恢复到可执行状态（恢复流程见 `references/resume-protocol.md`）。

---

## 5) 纠错与更新规则（保持可追溯）

当发现快照与代码事实/用户反馈冲突时：
- 先修正 `why.md#对齐摘要` / `task.md` / 实现之一，使三者重新一致（参考 `references/review-protocol.md`）
- 快照中保留纠错痕迹（推荐方式）：
  - 用 `~~过时内容~~` 划掉，并在下一行补充新结论与来源标签
  - 或追加 `### 修正记录`（≤5条），说明“原结论错在哪里/新证据是什么”

原则：快照必须支持“接手者无需回看聊天记录也能续作”。
