# Delphi / RAD Studio Playbook（推荐默认 + 少量硬禁止）

目标：当项目被判定为 Delphi（`*.dproj` / `*.dpr`）时，提供一套**默认不踩坑**、**默认可维护**、**默认可闭环（至少能编译）**的实现习惯。  
原则：Delphi 的构建/测试强依赖本机环境与工程设置，优先使用项目自带脚本/CI；没有明确入口时不猜命令。

---

## 硬禁止（高风险，默认不允许）

1. **后台线程禁止直接操作 UI**  
   - 必须用 `TThread.Queue` / `TThread.Synchronize` 回到 UI 线程。
2. **创建对象后禁止“裸奔不释放”**  
   - 需要明确所有权：要么 Owner/容器接管，要么用 `try..finally Free; end` 收口。
3. **禁用新代码中的 `AnsiString`（除非协议/ABI 边界）**  
   - 默认使用 `string`（UnicodeString）；涉及编码时在边界处显式转换，并写清编码（UTF-8/ANSI）。

---

## 推荐默认（更灵活；可被项目现状覆盖）

### 资源与所有权
- 默认用 `try..finally` 管对象生命周期；容器（如 `TObjectList<T>`）接管时明确 `OwnsObjects`。
- 尽量减少“全局单例 + 手工释放”的组合（容易泄漏与顺序问题），优先局部生命周期。

### 字符串与编码
- 对外边界（文件/网络/协议）统一做编码转换：内部统一用 `string`；外部显式标注 UTF-8。
- 避免在业务逻辑里散落 `UTF8Encode/UTF8Decode`；集中在边界层。

### 异常与错误
- 异常只在边界层捕获并加上下文（日志/错误码映射）；不要用异常做正常分支。
- 绝不吞异常（除非有明确的降级策略，并记录原因）。

### Unit 组织
- 默认“一个 unit 一个领域概念”；避免巨型 `Utils.pas`。
- 公共 API（函数/类）尽量有稳定入口点与命名，便于续作定位。

---

## 闭环（最小验证动作）

优先使用项目声明的 build/test 脚本或 CI 命令；缺失时：

- **快路径（最快信号）**：只做 `build`（能编译就是最高信号）
- **测试（如存在）**：若仓库有 DUnit/DUnitX 测试工程或脚本入口，以该入口作为 `test`

